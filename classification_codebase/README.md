# Verifying the Effectiveness of SLO Images Generated by Stable Diffusion and FairDiffusion


## Requirements

To install the prerequisites, run:

```
pip install - r requirements.txt
```

# Evaluate Fairness of Diffusion Model (Classification) - ViT-B
```
cd classification_codebase
DATASET_DIR=
RESULT_DIR=
MODEL_TYPE=ViT-B
MODALITY_TYPE=slo_fundus

VIT_WEIGHTS=imagenet
BATCH_SIZE=64
BLR=5e-4
WD=0.01
LD=0.55
DP=0.1

# Baselines
EXP_NAME=BASELINE_GLAUCOMA
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cls --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

EXP_NAME=BASELINE_MD_SEVERITY
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task md_severity --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

EXP_NAME=BASELINE_CDR_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cdr_status --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

EXP_NAME=BASELINE_SE_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task se_status --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

# Generated Dataset
EXP_NAME=FAIRDIFFUSION_GLAUCOMA
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cls --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

EXP_NAME=FAIRDIFFUSION_MD_SEVERITY
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task md_severity --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

EXP_NAME=FAIRDIFFUSION_CDR_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cdr_status --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

EXP_NAME=FAIRDIFFUSION_SE_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task se_status --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --epochs 50 --batch_size ${BATCH_SIZE} --blr ${BLR} --min_lr 1e-6 --warmup_epochs 5 --weight_decay ${WD} --layer_decay ${LD} --drop_path ${DP} --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE} --vit_weights ${VIT_WEIGHTS}

```


# Evaluate Fairness of Diffusion Model (Classification) - EfficientNet
```
cd classification_codebase

DATASET_DIR=
RESULT_DIR=
MODEL_TYPE=( efficientnet )
NUM_EPOCH=10
MODALITY_TYPE='slo_fundus'
ATTRIBUTE_TYPE=race

OPTIMIZER='adamw'
OPTIMIZER_ARGUMENTS='{"lr": 0.001, "weight_decay": 0.01}'

SCHEDULER='step_lr'
SCHEDULER_ARGUMENTS='{"step_size": 30, "gamma": 0.1}'

LR=1e-3

# Baselines
BATCH_SIZE=6
EXP_NAME=BASELINE_GLAUCOMA
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cls --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

BATCH_SIZE=6
EXP_NAME=BASELINE_MD_SEVERITY
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task md_severity --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

BATCH_SIZE=16
EXP_NAME=BASELINE_CDR_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cdr_status --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

BATCH_SIZE=16
EXP_NAME=BASELINE_SE_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task se_status --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

# Generated Dataset
BATCH_SIZE=6
EXP_NAME=FAIRDIFFUSION_GLAUCOMA
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cls --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

BATCH_SIZE=6
EXP_NAME=FAIRDIFFUSION_MD_SEVERITY
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task md_severity --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

BATCH_SIZE=16
EXP_NAME=FAIRDIFFUSION_CDR_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task cdr_status --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

BATCH_SIZE=16
EXP_NAME=FAIRDIFFUSION_SE_STATUS
PERF_FILE=${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME}.csv
python scripts/train_glaucoma_fair.py --task se_status --fairdiffusion --initial_model stabilityai/stable-diffusion-2-1 --model_path <OUTPUT_DIR>/checkpoint-<TBD>/unet --data_dir ${DATASET_DIR}/ --result_dir ${RESULT_DIR}/${MODEL_TYPE}_${MODALITY_TYPE}_${EXP_NAME} --model_type ${MODEL_TYPE} --image_size 200 --lr ${LR} --weight-decay 0. --momentum 0.1 --batch_size ${BATCH_SIZE} --epochs ${NUM_EPOCH} --modality_types ${MODALITY_TYPE} --perf_file ${PERF_FILE}

```